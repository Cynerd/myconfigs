#!/usr/bin/env bash
set -eu
if [ -f ./flake.nix ]; then
	echo "There is already existing flake.nix file!" >&2
	exit 1
fi
cat >./flake.nix <<"EOF"
{
  outputs = {
    self,
    systems,
    nixpkgs,
  }: let
    inherit (nixpkgs.lib) genAttrs composeManyExtensions;
    forSystems = genAttrs (import systems);
    withPkgs = func: forSystems (system: func self.legacyPackages.${system});
  in {
    overlays = {
      packages = final: prev: {};
      default = composeManyExtensions [self.overlays.packages];
    };

    devShells = withPkgs (pkgs: {
      default = with pkgs;
        mkShell {
          packages = [
            # TODO development packages
          ];
          inputsFrom = [
            # TODO other packages development is done for
          ];
        };
    });

    formatter = withPkgs (pkgs: pkgs.alejandra);

    legacyPackages =
      forSystems (system:
        nixpkgs.legacyPackages.${system}.extend self.overlays.default);
  };
}
EOF
